<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{common/head :: head}">
    <title>경기일정 및 예측</title>
</head>

<style>
    .main-title {
        width: 280px;
        height: 40px;
        margin-right: auto;
        margin-left: auto;
        margin-top: 50px;
        color: inherit;
    }

    .main-title-content {
        text-align: center;
        line-height: 18px;
        font-weight: 700;
        width: 280px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: inherit;
    }

    .date-picker-container {
        display: flex; /* 플렉스 박스를 사용하여 정렬 */
        justify-content: center; /* 수평 중앙 정렬 */
        align-items: center; /* 수직 중앙 정렬 */
        margin-top: 20px; /* 위쪽 여백 추가 */
        flex-direction: column; /* 세로 방향으로 정렬 */
    }

    .gameSchedule-list-container {
        display: flex;
        flex-direction: column;
        gap: 0px;
        align-items: flex-start;
        justify-content: flex-start;
        max-width: 800px; /* 원하는 고정 너비 */
        margin-right: auto;
        margin-left: auto;
        margin-top: 70px;
    }

    .date-header {
        border-bottom: 2px solid white; /* 날짜 헤더에 밑줄 추가 */
        margin-bottom: 10px; /* 아래쪽 여백 추가 */
        padding-bottom: 5px; /* 패딩 추가 */
        width:800px; /* 메인 컨텐츠 너비 만큼 */
    }

    /* 경기 항목에 margin-bottom 추가 */
    #gameSchedule-list li {
        margin-bottom: 20px; /* 원하는 아래쪽 여백 */
        display: inline-block; /* 가로로 배치 */
        width: calc(50% - 10px); /* 두 개의 경기를 가로로 배치하기 위한 너비 */
        vertical-align: top; /* 상단 정렬 */
    }

    /* 경기 목록에 대한 스타일 */
    .match-container {
        display: flex; /* flexbox로 경기 일정 배치 */
        flex-wrap: wrap; /* 줄 바꿈 */
        justify-content: space-between; /* 간격을 균등하게 */
    }
    /* 리그 헤더 */
    .league-header {
        border-bottom: 1px solid #666; /* 리그 헤더에 밑줄 추가 */
        margin-bottom: 8px; /* 아래쪽 여백 추가 */
        padding-bottom: 4px; /* 패딩 추가 */
        width:800px; /* 메인 컨텐츠 너비만큼 */
    }
    /* 경기 하나당 최소 너비 설정 */
    .match-item{
        min-width: 400px;
    }
    /* 경기시간 스타일 */
    .matchTime {
        display: inline-block; /* 경기 시간, '홈', 팀명, 스코어를 가로로 배치하기 위해 */
        font-weight: bold;
        min-width: 40px; /* 최소 너비 */
    }
    /* 홈팀 명시 스타일 */
    .home-label {
        display: inline-block;
        /*justify-content: center;*/
        /*align-items: center;*/
        background-color: #43a047; /* 원하는 배경색 */
        color: #FFFFFF; /* 텍스트 색상 */
        height: 8px; /* 높이 16px */
        width: 12px; /* 너비 20px */
        text-align: center;
        padding: 4px 4px; /* 상하 여백, 좌우 여백 */
        border-radius: 3px;
        font-weight: bold;
        font-size: 0.7rem;
    }
    /* 스코어 스타일 */
    .score {
        font-weight: bold; /* 스코어 굵게 */
    }

    .low-score {
        color: #ffffff; /* 낮은 점수 색상 */
    }

    .high-score {
        color: #cdf256; /* 높은 점수 색상 */
    }

</style>

<body>
<header th:replace="~{common/header-2 :: header-2}"></header>
<div class="make-header-margin"></div>

<div class="main-content">
    <div class="main-title">
        <h1 class="main-title-content">경기 일정</h1>
    </div>

    <!-- 날짜 선택 추가 -->
    <div class="date-picker-container">
        <label for="datepicker">날짜 선택:</label>
        <input type="text" id="datepicker" readonly style="color: #1e1e1e; padding: 2px 5px 0 5px">
    </div>

    <div class="gameSchedule-list-container">
        <ul id="gameSchedule-list">
        </ul>
    </div>
</div>

<!-- 경기일정 Ajax 요청 -->

<script th:inline="javascript">
    $(function () {
        // 현재 날짜 가져오기
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0]; // 'YYYY-MM-DD' 형식으로 변환
        $("#datepicker").val(formattedDate); // 기본값으로 설정

        // Datepicker 초기화
        $("#datepicker").datepicker({
            dateFormat: "yy-mm-dd",
            defaultDate: today, // 기본 날짜 설정
            onSelect: function (selectedDate) {
                loadGameSchedules(selectedDate); // 선택한 날짜의 경기 일정 로드
            }
        });

        // 기본 로드 시 현재 날짜의 경기 일정 로드
        loadGameSchedules(formattedDate);

        // AJAX 요청 함수
        function loadGameSchedules(selectedDate) {
            $.ajax({
                type: "GET",
                url: "/usr/home/gameSchedule/date",
                data: { date: selectedDate },
                success: function (response) {
                    // 응답이 map인지 확인
                    if (response) {
                        $("#gameSchedule-list").empty(); // 기존 경기 일정 초기화

                        let currentDate = ""; // 현재 날짜 초기화
                        let currentLeague = ""; // 현재 리그 초기화

                        $("#gameSchedule-list").append(`<h3 class="date-header">` + selectedDate + `</h3>`);

                        if (!response || !response.schedules || response.schedules.length === 0) {
                            $("#gameSchedule-list").append(`<li class="no-game">해당 날짜에는 경기가 없습니다.</li>`);
                            return;
                        }

                        // 각 경기 일정 처리
                        response.schedules.forEach(function (gameSchedule) {
                            const loginedMember = response.loginedMember;
                            const userPredictionsMap = response.userPredictionsMap;

                            // 경기 시작일과 시간
                            const gameStartLocalDateTime = gameSchedule.startDate + "T" + gameSchedule.matchTime;
                            const isFutureGame = new Date() < new Date(gameStartLocalDateTime);

                            // 선택한 날짜와 같은 경기만 표시
                            if (selectedDate === gameSchedule.startDate) {
                                // 리그 이름 표시
                                if (currentLeague !== gameSchedule.leagueName) {
                                    currentLeague = gameSchedule.leagueName;
                                    $("#gameSchedule-list").append(`<h4 class="league-header">` + currentLeague + `</h4><div class="league-block"><div class="match-container">`);
                                }

                                // 경기 정보 추가
                                let listItem = createMatchItem(gameSchedule, isFutureGame, loginedMember, userPredictionsMap);
                                $("#gameSchedule-list").append(listItem);
                            }
                        });

                        // 경기 끝나고 league-block 닫기
                        $("#gameSchedule-list").append("</div></div>");
                    } else {
                        alert("잘못된 응답 형식입니다."); // 배열이 아닌 경우 경고
                    }
                },
                error: function (xhr) {
                    alert("경기 일정을 불러오는 중 문제가 발생했습니다.");
                }
            });
        }

        // 경기 정보를 리스트 아이템으로 생성하는 함수
        function createMatchItem(gameSchedule, isFutureGame, loginedMember, userPredictionsMap) {
            let listItem = $(`<li class="match-item"></li>`)
                .append(`<span class="matchTime">` + gameSchedule.matchTime + `</span>`)
                .append(`<span class="home-label">홈</span>`) // 홈 라벨
                .append(`<span style="margin-right: 5px;">` + gameSchedule.homeTeam + `</span>`);

            // 점수 표시
            if (gameSchedule.homeTeamScore !== '' && gameSchedule.awayTeamScore !== '') {
                let homeScoreClass = gameSchedule.homeTeamScore > gameSchedule.awayTeamScore ? 'high-score' : 'low-score';
                let awayScoreClass = gameSchedule.awayTeamScore > gameSchedule.homeTeamScore ? 'high-score' : 'low-score';

                listItem.append(`<span class="score ` + homeScoreClass + `">` + gameSchedule.homeTeamScore + `</span> : <span class="score ` + awayScoreClass + `">` + gameSchedule.awayTeamScore + `</span>`);
            } else {
                // 점수가 없을 경우 'vs' 추가
                listItem.append(`<span> vs </span>`);
            }

            // awayTeam을 추가
            listItem.append(`<span style="margin: 0 5px;">` + gameSchedule.awayTeam + `</span>`);

            // 예측 버튼 처리
            if (loginedMember) {
                let userPrediction = userPredictionsMap ? userPredictionsMap[gameSchedule.id] : null;

                // 예측 버튼을 inline-block으로 설정
                let predictionButtons = $('<div style="display: inline-block;"></div>');
                ['승', '무', '패'].forEach(function (prediction) {
                    let button = $(`<button class="prediction-button" style="margin: 0 2px;" data-prediction="` + prediction + `" data-game-id="` + gameSchedule.id + `" data-member-id="` + loginedMember.id + `"></button>`)
                        .text(prediction)
                        .css("background-color", userPrediction === prediction ? (prediction === '승' ? 'green' : (prediction === '무' ? 'yellow' : 'red')) : 'white');

                    // 미래 경기일 경우 버튼 활성화, 과거 경기일 경우 비활성화
                    if (!isFutureGame) {
                        button.prop('disabled', true);
                    }

                    predictionButtons.append(button);
                });

                listItem.append(predictionButtons);
            }

            return listItem;
        }

        // 예측 버튼 클릭 AJAX 요청
        $('#gameSchedule-list').on('click', '.prediction-button', function (event) {
            event.preventDefault();

            var prediction = $(this).data('prediction');
            var gameId = $(this).data('game-id');
            var memberId = $(this).data('member-id');

            // 각 값이 올바르게 설정되었는지 확인하기 위해 콘솔 로그 추가
            console.log("prediction:", prediction);
            console.log("gameId:", gameId);
            console.log("memberId:", memberId);

            // 빈 값이거나 설정되지 않은 값이 있을 경우 경고창 표시
            if (!gameId || !memberId) {
                alert("게임 ID와 회원 ID는 필수입니다.");
                return;
            }

            // 예측 값을 서버로 전송
            $.ajax({
                type: "POST",
                url: "/predict",
                data: {
                    gameId: gameId,
                    memberId: memberId,
                    prediction: prediction
                },
                success: function (response) {
                    console.log("응답:", response);  // 응답 객체 확인
                    if (response.error) {
                        // 서버에서 오류 메시지를 받은 경우
                        alert(response.error);
                    } else {
                        alert("예측이 성공적으로 저장되었습니다."); // 성공 메시지 추가

                        // 예측한 경기의 날짜를 가져오기 위해 gameSchedule에서 날짜를 찾는 로직 추가
                        const selectedGameSchedule = response.gameSchedule; // 예측된 경기 정보
                        const selectedDate = selectedGameSchedule.startDate; // 예측된 경기의 날짜

                        // 현재 보고 있는 날짜로 경기 일정 다시 로드
                        loadGameSchedules(selectedDate);
                    }
                },
                error: function (xhr) {
                    // 오류 발생 시 서버에서 반환한 메시지를 표시
                    var errorMessage = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : "예측을 저장하는 중 문제가 발생했습니다.";
                    alert(errorMessage);
                }
            });
        });
    });
</script>
<footer th:replace="~{common/footer :: footer}"></footer>
</body>
</html>
